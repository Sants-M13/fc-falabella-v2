# Story 1.5: Melhorias no Sistema de Produtos - Curvas de Tamanho e Funcionalidades Avançadas

## Status
Pending

## Story
**As a** System Administrator,
**I want** enhanced product management capabilities including flexible SKU formats, optional cost fields, size curve automation, and product images,
**so that** I can efficiently manage complex product catalogs with automated variant creation based on predefined size curves and complete product information.

## Story Context

**Previous Story Dependencies (Story 1.4):**
- Complete product and variant management system with CRUD operations
- PostgreSQL database with products/variants tables and RLS policies
- React Hook Form + Zod validation patterns established
- TanStack Query for data fetching and caching
- shadcn/ui component library integration
- Spanish (es-CO) localization infrastructure
- Colombian Peso (COP) currency formatting utilities
- Admin-only access control patterns

**Current Story Integration Points:**
- Extends existing product management without breaking changes
- Adds new optional features: size curves, product images, barcode tracking
- Maintains all existing validation patterns and business logic
- Preserves backward compatibility with manual variant creation
- Follows established file structure in `/apps/web/components/admin/products/`

## Acceptance Criteria

### Functional Requirements:

1. **Flexible SKU Format**: SKU validation must accept alphanumeric characters with hyphens (e.g., "1184-1101-7286-15745")
2. **Optional Cost Field**: Cost field should be optional in product creation and editing forms
3. **Product Images**: Products must support image upload/URL with display in catalog and forms
4. **Size Curves System**: System must support predefined size curves for automatic variant generation
5. **Curve-Based Variant Creation**: When creating a product with a selected curve, variants are automatically generated
6. **Curve Management**: Admin can create, edit, and delete size curves with name and size list
7. **Flexible Curve Usage**: Admin can add/remove sizes temporarily without modifying the base curve
8. **Hierarchical SKU Generation**: Child SKUs automatically generated as "{parent_sku}-{size}"
9. **Variant Barcode Management**: Each variant must support barcode field for inventory tracking and POS integration

### Integration Requirements:
10. Existing product functionality continues to work unchanged
11. New functionality follows existing form validation and CRUD patterns
12. Integration with products/variants tables maintains current behavior and RLS policies

### Quality Requirements:
13. All changes covered by comprehensive unit and component tests
14. Spanish (es-CO) localization maintained throughout new features
15. Colombian Peso (COP) currency formatting preserved
16. Responsive design maintained for new UI components
17. No regression in existing product management functionality

## Tasks / Subtasks

- [ ] Task 1: SKU Validation and Cost Field Updates (AC: 1, 2)
  - [ ] Update Zod schema to accept hyphens in SKU validation
  - [ ] Modify product validation to make cost field optional
  - [ ] Update form components to handle optional cost field
  - [ ] Add conditional rendering for cost field in displays
  - [ ] Update TypeScript interfaces for optional cost
  - [ ] Create unit tests for new SKU format validation

- [ ] Task 2: Product Image Management (AC: 3)
  - [ ] Add image_url field to products table migration
  - [ ] Update TypeScript interfaces and Zod schemas for image field
  - [ ] Create image upload/URL input component with validation
  - [ ] Add image display in product catalog (table and card views)
  - [ ] Implement image preview in product forms
  - [ ] Add image handling in product CRUD operations
  - [ ] Create fallback image for products without images

- [ ] Task 3: Variant Barcode Management (AC: 9)
  - [ ] Add barcode field to variants table migration
  - [ ] Update TypeScript interfaces for Variant model with barcode
  - [ ] Add Zod schema validation for barcode format
  - [ ] Implement barcode input component with validation
  - [ ] Add barcode display in variant lists and product views
  - [ ] Create barcode uniqueness validation (optional constraint)
  - [ ] Add barcode field to variant CRUD operations

- [ ] Task 4: Size Curves Data Model (AC: 4, 6)
  - [ ] Create size_curves table migration with name and sizes array
  - [ ] Add RLS policies for admin-only access to size_curves
  - [ ] Create TypeScript interfaces for SizeCurve model
  - [ ] Add Zod schemas for size curve validation
  - [ ] Implement size curve CRUD operations in service layer
  - [ ] Create database indexes for performance optimization

- [ ] Task 5: Size Curves Management Interface (AC: 6)
  - [ ] Create size curves management page at /admin/size-curves
  - [ ] Implement size curves list component with CRUD actions
  - [ ] Create size curve form component (create/edit)
  - [ ] Add size curve deletion with dependency checking
  - [ ] Implement search and filtering for size curves
  - [ ] Add navigation link in admin sidebar

- [ ] Task 6: Curve-Based Variant Generation (AC: 5, 7, 8)
  - [ ] Add size_curve_id field to products table (optional FK)
  - [ ] Create curve selector in product form
  - [ ] Implement automatic variant generation logic
  - [ ] Add temporary size modification interface
  - [ ] Create hierarchical SKU generation function
  - [ ] Handle curve changes and variant updates
  - [ ] Add bulk variant operations (create/delete)

- [ ] Task 7: Enhanced Product Forms Integration (AC: 7, 8)
  - [ ] Integrate curve selector into product creation form
  - [ ] Add variant preview with generated SKUs
  - [ ] Implement temporary size additions/removals interface
  - [ ] Create variant management panel in product form
  - [ ] Add confirmation dialogs for bulk operations
  - [ ] Update form validation for curve-based workflows

- [ ] Task 8: Testing Implementation (Quality Assurance)
  - [ ] Unit tests for SKU validation with hyphens
  - [ ] Unit tests for optional cost field handling
  - [ ] Unit tests for barcode validation and uniqueness
  - [ ] Unit tests for size curve CRUD operations
  - [ ] Unit tests for variant generation algorithms
  - [ ] Component tests for new form components
  - [ ] Component tests for size curve management
  - [ ] E2E tests for complete curve-based product creation
  - [ ] E2E tests for image upload and display workflows
  - [ ] E2E tests for barcode input and validation workflows
  - [ ] Integration tests for variant generation scenarios

## Testing Standards

### Testing Framework Requirements
**From Architecture Standards:**
- **Unit Tests**: Vitest for business logic and utility functions
- **E2E Tests**: MCP Playwright for critical user flows
- **Component Tests**: React Testing Library with Vitest
- **Coverage Target**: 80% minimum for utils and services

### Test File Locations
```
/apps/web/__tests__/
├── components/admin/size-curves/     # Component tests
├── components/admin/products/        # Enhanced product component tests
├── lib/actions/                     # Service layer tests
├── lib/validations/                 # Schema validation tests
└── lib/utils/                       # Utility function tests

/apps/web/e2e/
├── size-curves.spec.ts              # Size curve management E2E
├── product-creation-curves.spec.ts  # Curve-based product creation
└── product-images-barcodes.spec.ts  # Image and barcode workflows
```

### Required Test Categories
1. **NFR1 Localization Tests**: Verify Spanish (es-CO) text in all new components
2. **Currency Formatting Tests**: Validate COP formatting preserved
3. **Access Control Tests**: Verify admin-only restrictions for size curves
4. **Performance Tests**: Bulk variant generation under 3s load time
5. **Cross-browser Tests**: Chrome, Firefox, Safari compatibility
6. **Mobile Responsive Tests**: Components work on mobile viewports

## NFR & UX Requirements

### NFR1 - Localization (CRITICAL)
- **Language**: All new UI text in Spanish (Colombia) - es-CO
- **Labels**: Size curves, image management, and form labels in Spanish
- **Messages**: All error messages and success notifications in Spanish
- **Currency**: Maintain Colombian Peso (COP) formatting for price fields
- **Validation Messages**: SKU format errors and curve validation in Spanish

### NFR3 - Access Control
- **Admin-Only**: Size curve management restricted to admin role
- **RLS Policies**: Database-level enforcement for size_curves table
- **Permissions**: Image upload and curve creation admin-only

### UX Principles
- **Progressive Enhancement**: Curve selection enhances but doesn't complicate basic product creation
- **Clear Workflow**: Intuitive curve selection and variant preview
- **Bulk Operations**: Efficient management of multiple variants
- **Visual Feedback**: Clear indication of generated variants and SKU hierarchy
- **Flexibility**: Easy switching between manual and curve-based variant creation

### Design System Requirements
- **Components**: Continue using shadcn/ui components exclusively
- **New Components**: FileInput for images, MultiSelect for sizes, CollapsiblePanel for variants
- **Theme**: Maintain Falabella colors and typography
- **Layout**: Responsive design for new management interfaces

### Performance & Responsive
- **Bulk Operations**: Efficient handling of multiple variant creation
- **Image Loading**: Optimized image display with lazy loading
- **Curve Management**: Fast filtering and search for large curve lists
- **Form Performance**: Smooth interaction during variant generation

## Technical Notes

### Database Schema Changes

**Products Table Updates:**
```sql
ALTER TABLE products 
ADD COLUMN image_url TEXT,
ADD COLUMN cost DECIMAL(10,2), -- Remove NOT NULL constraint
ADD COLUMN size_curve_id UUID REFERENCES size_curves(id);
```

**Variants Table Updates:**
```sql
ALTER TABLE variants 
ADD COLUMN barcode TEXT UNIQUE; -- Optional unique constraint for barcode tracking
```

**New Size Curves Table:**
```sql
CREATE TABLE size_curves (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  sizes TEXT[] NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### SKU Validation Pattern
```typescript
const skuPattern = /^[a-zA-Z0-9\-]{1,50}$/; // Allow hyphens
```

### Variant Generation Algorithm
```typescript
function generateVariants(parentSku: string, sizes: string[]) {
  return sizes.map(size => ({
    sku_child: `${parentSku}-${size}`,
    size: size
  }));
}
```

### Integration Approach
- Extend existing product forms with curve selection
- Maintain backward compatibility with manual variant creation
- Add progressive enhancement for curve-based workflows
- Preserve all existing validation and business logic

### Key Constraints
- Must not break existing product functionality
- Size curves are admin-manageable but optional
- Generated variants follow existing validation rules
- Image handling must be secure and optimized
- Bulk operations must handle errors gracefully

## Risk and Compatibility Check

**Primary Risk:** Complexity of variant generation affecting form performance
**Mitigation:** Implement debounced generation with loading states and validation

**Compatibility Verification:**
- No breaking changes to existing product APIs
- Database changes are additive only (new columns, new table)
- UI changes extend existing patterns without modification
- Performance impact minimized through efficient algorithms

## Definition of Done

### Story-Level Requirements:
- [ ] All functional requirements (1-8) implemented and tested
- [ ] Integration requirements (9-11) verified with existing functionality
- [ ] Quality requirements (12-16) met with comprehensive testing
- [ ] Spanish localization complete for all new features
- [ ] Colombian Peso formatting maintained
- [ ] Admin-only access control enforced
- [ ] Responsive design implemented for all new components

### Code Quality:
- [ ] TypeScript strict mode compliance
- [ ] ESLint passes without new errors
- [ ] All new code follows existing patterns
- [ ] Database migrations properly structured
- [ ] RLS policies correctly implemented

### Testing:
- [ ] Unit tests for all new utility functions
- [ ] Component tests for all new React components
- [ ] E2E tests for complete workflows
- [ ] Regression testing for existing functionality
- [ ] Performance testing for bulk operations

### Documentation:
- [ ] Story documentation complete
- [ ] Database schema changes documented
- [ ] Component specifications updated
- [ ] Technical decisions recorded

## Dev Notes

### Previous Story Dependencies
From Story 1.4 completion:
- Products and variants tables with RLS policies
- React Hook Form + Zod validation patterns
- TanStack Query for data fetching
- shadcn/ui component integration
- Spanish localization infrastructure
- Currency formatting utilities

### File Locations
```
/apps/web/app/(admin)/admin/size-curves/     # Size curve management pages
/apps/web/components/admin/size-curves/      # Size curve components
/apps/web/components/admin/products/         # Enhanced product components
/apps/web/lib/actions/size-curves.ts         # Size curve service functions
/apps/web/lib/validations/size-curves.ts     # Size curve validation schemas
/apps/web/lib/utils/variant-generation.ts    # Variant generation utilities
```

### Migration Strategy
1. Database migrations for schema changes
2. Update existing TypeScript interfaces
3. Extend existing validation schemas
4. Enhance existing product components
5. Add new size curve management system
6. Comprehensive testing of all changes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | Initial story creation with comprehensive requirements | Sarah (Product Owner) |
| 2025-08-21 | 1.1 | Added Story Context and Testing sections per template compliance | Sarah (Product Owner) |
| 2025-08-21 | 1.2 | Updated architecture docs: data models and API specification | Sarah (Product Owner) |

## Example Use Cases

### Use Case 1: Create Product with Curve
1. Admin creates new product with basic info
2. Selects "Femenina" curve (sizes 34-41)
3. System auto-generates 8 variants with SKUs like "1184-1101-7286-15745-34"
4. Admin can add temporary size 42 without modifying base curve
5. Product created with 9 variants total

### Use Case 2: Manage Size Curves
1. Admin creates new curve "Masculina" with sizes 38-46
2. System validates unique curve name
3. Curve becomes available for product creation
4. Admin can edit curve sizes (with warning about existing products)
5. Admin can delete unused curves

### Use Case 3: Enhanced Product Management with Barcodes
1. Admin uploads product image via URL or file
2. Cost field left empty (optional)
3. SKU format "NIKE-AIR-MAX-2024" accepted
4. For each variant, admin adds unique barcode (e.g., "7891234567890")
5. System validates barcode uniqueness across all variants
6. Product displays in catalog with image, barcodes, and proper formatting
7. Barcodes enable inventory tracking and POS integration
8. All existing functionality preserved

### Use Case 4: Barcode Management
1. Admin creates product with curve, generating multiple variants
2. System auto-generates SKUs but leaves barcodes empty
3. Admin can bulk-enter barcodes or leave them for later
4. Barcode uniqueness validated on save
5. Variants can be identified by either SKU or barcode in inventory system